unit TesteWK.View.Principal;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants,
  System.Classes, Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs,
  Vcl.ExtCtrls, Vcl.StdCtrls,
  TesteWK.Classe.Cliente, TesteWK.Classe.Produto, TesteWK.Classe.Pedido,
  TesteWK.Controller,
  FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf,
  FireDAC.DApt.Intf, Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client,
  Vcl.Grids, Vcl.DBGrids;

type
  TfrmPrincipal = class(TForm)
    panPedido: TPanel;
    panItensPedido: TPanel;
    lblCliente: TLabel;
    cmbCliente: TComboBox;
    lblCodigoProduto: TLabel;
    edtCodigoProduto: TEdit;
    edtDescricaoProduto: TEdit;
    lblDescricaoProduto: TLabel;
    lblQuantidadeProduto: TLabel;
    edtQuantidadeProduto: TEdit;
    lblValorUnitarioProduto: TLabel;
    edtValorUnitarioProduto: TEdit;
    btnRegistrar: TButton;
    dsPedidos_Produtos: TDataSource;
    dsPedidos: TDataSource;
    DBGrid1: TDBGrid;
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure edtCodigoProdutoKeyPress(Sender: TObject; var Key: Char);
    procedure edtQuantidadeProdutoKeyPress(Sender: TObject; var Key: Char);
    procedure edtValorUnitarioProdutoKeyPress(Sender: TObject; var Key: Char);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure edtCodigoProdutoExit(Sender: TObject);
    procedure cmbClienteChange(Sender: TObject);
    procedure btnRegistrarClick(Sender: TObject);
  private
    { Private declarations }
    fPedido: TWKPedido;
    fController: TController;
    procedure CarregaClientes;
  public
    { Public declarations }
  end;

var
  frmPrincipal: TfrmPrincipal;

implementation

uses
   TesteWK.Model.Entidade.Pedido;

{$R *.dfm}

{ TfrmPrincipal }

procedure TfrmPrincipal.btnRegistrarClick(Sender: TObject);
begin
   if fController.Pedido.IsEmpty then
      begin
         APedido := TWKPedido.Create;
      end;
end;

procedure TfrmPrincipal.CarregaClientes;
var
   ALista: TListaWKClientes;
   AIndex: Integer;
begin
   ALista := TListaWKClientes.Create;
   try
      ALista := fController.Cliente.GetClientes();
      cmbCliente.Items.Clear;
      for AIndex := 0 to ALista.Tamanho - 1 do
         begin
            cmbCliente.Items.Add(ALista.Items[AIndex].Nome);
         end;
   finally
      FreeAndNil(ALista);
   end;
end;

procedure TfrmPrincipal.cmbClienteChange(Sender: TObject);
begin
   if TComboBox(Sender).ItemIndex >= 0 then
      begin
         fController.Pedido.OpenWhere('WHERE codigo_cliente = ' + fController.Cliente.GetCodigo(TComboBox(Sender).Items[TComboBox(Sender).ItemIndex]));
      end;
end;

procedure TfrmPrincipal.edtCodigoProdutoExit(Sender: TObject);
var
   AProduto: TWKProduto;
begin
   AProduto := TWKProduto.Create;
   try
      AProduto := fController.Produto.GetProduto(TEdit(Sender).Text);
      if Assigned(AProduto) then
         begin
            edtDescricaoProduto.Text := AProduto.Descricao;
            edtQuantidadeProduto.Text := '1.00';
            edtValorUnitarioProduto.Text := FloatToStr(AProduto.PrecoVenda);
         end;
   finally
      FreeAndNil(AProduto);
   end;
end;

procedure TfrmPrincipal.edtCodigoProdutoKeyPress(Sender: TObject;
  var Key: Char);
begin
   if not (CharInSet(Key, ['0'..'9', #8])) then
      Key := #0;
end;

procedure TfrmPrincipal.edtQuantidadeProdutoKeyPress(Sender: TObject;
  var Key: Char);
var
   AFormato: TFormatSettings;
begin
   GetLocaleFormatSettings(LOCALE_SYSTEM_DEFAULT, AFormato);
   if not (CharInSet(Key, ['0'..'9', AFormato.DecimalSeparator, #8])) then
      Key := #0;
end;

procedure TfrmPrincipal.edtValorUnitarioProdutoKeyPress(Sender: TObject;
  var Key: Char);
var
   AFormato: TFormatSettings;
begin
   GetLocaleFormatSettings(LOCALE_SYSTEM_DEFAULT, AFormato);
   if not (CharInSet(Key, ['0'..'9', AFormato.DecimalSeparator, #8])) then
      Key := #0;
end;

procedure TfrmPrincipal.FormCreate(Sender: TObject);
begin
   fController := TController.Create;
end;

procedure TfrmPrincipal.FormDestroy(Sender: TObject);
begin
   FreeAndNil(fController);
end;

procedure TfrmPrincipal.FormKeyPress(Sender: TObject; var Key: Char);
begin
   if Key = #13 then
      begin
         Key := #0;
         Perform(WM_NEXTDLGCTL, 0, 0);
      end;
end;

procedure TfrmPrincipal.FormShow(Sender: TObject);
begin
   CarregaClientes;
end;

end.
