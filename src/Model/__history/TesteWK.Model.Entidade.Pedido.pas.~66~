unit TesteWK.Model.Entidade.Pedido;

interface

uses
  System.SysUtils, System.Classes, FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf,
  FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt, Data.DB,
  FireDAC.Comp.DataSet, FireDAC.Comp.Client,
  TesteWK.Classe.Pedido;

type
  TModelEntidadePedido = class(TDataModule)
    qryPedidos: TFDQuery;
    qryPedidos_Produtos: TFDQuery;
    dsPedidos: TDataSource;
    qryPedidosnumero: TFDAutoIncField;
    qryPedidosdata_emissao: TDateField;
    qryPedidoscodigo_cliente: TWideStringField;
    qryPedidosvalor_total: TFloatField;
    qryPedidos_Produtosid: TFDAutoIncField;
    qryPedidos_Produtosnumero_pedido: TLongWordField;
    qryPedidos_Produtoscodigo_produto: TWideStringField;
    qryPedidos_Produtosquantidade: TFloatField;
    qryPedidos_Produtosvalor_unitario: TFloatField;
    qryPedidos_Produtosvalor_total: TFloatField;
    qryPedidos_Produtosdescricao_produto_lookup: TStringField;
    procedure qryPedidos_ProdutosNewRecord(DataSet: TDataSet);
    procedure qryPedidos_ProdutosCalcFields(DataSet: TDataSet);
  private
    { Private declarations }
  public
    { Public declarations }
    procedure OpenWhere(ClausulaWhere: String = '');
    function IsEmpty: Boolean;
    function GetPedido(const ANumero: Integer): TWKPedido;
    function GetPedidos(const ANumero: Integer = 0): TListaWKPedidos;
    function GetItensPedido(const ANumero: Integer): TListaWKItensPedido;
    function InserePedido(APedido: TWKPedido): Integer;
  end;

implementation

{%CLASSGROUP 'Vcl.Controls.TControl'}

uses
   Windows,
   TesteWK.Model.Conexao,
   TesteWK.Model.Entidade.Cliente, TesteWK.Model.Entidade.Produto;

{$R *.dfm}

{ TModelEntidadePedido }

function TModelEntidadePedido.GetItensPedido(
  const ANumero: Integer): TListaWKItensPedido;
var
   AItemPedido: TWKItemPedido;
begin
   Result := TListaWKItensPedido.Create;
   if not qryPedidos_Produtos.IsEmpty then
      begin
         qryPedidos_Produtos.First;
         while not qryPedidos_Produtos.Eof do
            begin
               AItemPedido := TWKItemPedido.Create;
               AItemPedido.Id := qryPedidos_Produtos.FieldByName('id').AsInteger;
               AItemPedido.CodigoProduto := qryPedidos_Produtos.FieldByName('codigo_produto').AsString;
               AItemPedido.Quantidade := qryPedidos_Produtos.FieldByName('quantidade').AsFloat;
               AItemPedido.ValorUnitario := qryPedidos_Produtos.FieldByName('valor_unitario').AsFloat;
               AItemPedido.ValorTotal := qryPedidos_Produtos.FieldByName('valor_unitario').AsFloat * qryPedidos_Produtos.FieldByName('quantidade').AsFloat;
               Result.Add(AItemPedido);
            end;
      end;
end;

function TModelEntidadePedido.GetPedido(const ANumero: Integer): TWKPedido;
var
   AClienteModel: TModelEntidadeCliente;
   AItemPedido: TWKItemPedido;
begin
   OpenWhere('WHERE numero = ' + ANumero.ToString);
   Result := TWKPedido.Create;
   if not qryPedidos.IsEmpty then
      begin
         Result.Numero := qryPedidos.FieldByName('numero').AsInteger;
         Result.DataEmissao := qryPedidos.FieldByName('data_emissao').AsDateTime;
         AClienteModel := TModelEntidadeCliente.Create(Nil);
         try
            Result.Cliente := AClienteModel.GetCliente(qryPedidos.FieldByName('codigo_cliente').AsString);
         finally
            FreeAndNil(AClienteModel);
         end;
         Result.ValorTotal := qryPedidos.FieldByName('valor_total').AsFloat;
         if not qryPedidos_Produtos.IsEmpty then
            begin
               qryPedidos_Produtos.First;
               while not qryPedidos_Produtos.Eof do
                  begin
                     AItemPedido := TWKItemPedido.Create;
                     AItemPedido.Id := qryPedidos_Produtos.FieldByName('id').AsInteger;
                     AItemPedido.CodigoProduto := qryPedidos_Produtos.FieldByName('codigo_produto').AsString;
                     AItemPedido.Quantidade := qryPedidos_Produtos.FieldByName('quantidade').AsFloat;
                     AItemPedido.ValorUnitario := qryPedidos_Produtos.FieldByName('valor_unitario').AsFloat;
                     AItemPedido.ValorTotal := qryPedidos_Produtos.FieldByName('valor_unitario').AsFloat * qryPedidos_Produtos.FieldByName('quantidade').AsFloat;
                     Result.ItensPedido.Add(AItemPedido);
                     qryPedidos_Produtos.Next;
                  end;
            end;
      end;
end;

function TModelEntidadePedido.GetPedidos(
  const ANumero: Integer): TListaWKPedidos;
var
   APedido: TWKPedido;
   AClienteModel: TModelEntidadeCliente;
   AItemPedido: TWKItemPedido;
begin
   if ANumero > 0 then
      OpenWhere('WHERE numero = ' + ANumero.ToString)
   else
      OpenWhere();
   Result := TListaWKPedidos.Create;
   if not qryPedidos.IsEmpty then
      begin
         qryPedidos.First;
         while not qryPedidos.Eof do
            begin
               APedido := TWKPedido.Create;
               APedido.Numero := qryPedidos.FieldByName('numero').AsInteger;
               APedido.DataEmissao := qryPedidos.FieldByName('data_emissao').AsDateTime;
               AClienteModel := TModelEntidadeCliente.Create(Nil);
               try
                  APedido.Cliente := AClienteModel.GetCliente(qryPedidos.FieldByName('codigo_cliente').AsString);
               finally
                  FreeAndNil(AClienteModel);
               end;
               APedido.ValorTotal := qryPedidos.FieldByName('valor_rotal').AsFloat;
               if not qryPedidos_Produtos.IsEmpty then
                  begin
                     qryPedidos_Produtos.First;
                     while not qryPedidos_Produtos.Eof do
                        begin
                           AItemPedido := TWKItemPedido.Create;
                           AItemPedido.Id := qryPedidos_Produtos.FieldByName('id').AsInteger;
                           AItemPedido.CodigoProduto := qryPedidos_Produtos.FieldByName('codigo_produto').AsString;
                           AItemPedido.Quantidade := qryPedidos_Produtos.FieldByName('quantidade').AsFloat;
                           AItemPedido.ValorUnitario := qryPedidos_Produtos.FieldByName('valor_unitario').AsFloat;
                           AItemPedido.ValorTotal := qryPedidos_Produtos.FieldByName('valor_unitario').AsFloat * qryPedidos_Produtos.FieldByName('quantidade').AsFloat;
                           APedido.ItensPedido.Add(AItemPedido);
                           qryPedidos_Produtos.Next;
                        end;
                  end;
               Result.Add(APedido);
            end;
      end;
end;

function TModelEntidadePedido.InserePedido(APedido: TWKPedido): Integer;
var
   AQuery: TFDQuery;
begin
   AQuery := TFDQuery.Create(Nil);
   try
      AQuery.Connection := ModelConexao.conConexaoServidor;
      with AQuery.SQL do
         begin
            Clear;
            Add('INSERT INTO pedidos');
            Add('   (data_emissao, codigo_cliente, valor_total)');
            Add('VALUES');
            Add('   (:data_emissao, :codigo_cliente, :valor_total)');
            Add('RETURNING numero');
         end;
      // Definição dos parâmetros
      AQuery.ParamByName('data_emissao').DataType := ftDateTime;
      AQuery.ParamByName('data_emissao').ParamType := ptInput;
      AQuery.ParamByName('data_emissao').Value := APedido.DataEmissao;
      AQuery.ParamByName('codigo_cliente').DataType := ftString;
      AQuery.ParamByName('codigo_cliente').ParamType := ptInput;
      AQuery.ParamByName('codigo_cliente').Value := APedido.Cliente.Codigo;
      AQuery.ParamByName('valor_total').DataType := ftFloat;
      AQuery.ParamByName('valor_total').ParamType := ptInput;
      AQuery.ParamByName('valor_total').Value := APedido.ValorTotal;
      AQuery.ExecSQL;
      Result := AQuery.Fields[0].Value;
   finally
      FreeAndNil(AQuery);
   end;
end;

function TModelEntidadePedido.IsEmpty: Boolean;
begin
   Result := qryPedidos.IsEmpty;
end;

procedure TModelEntidadePedido.OpenWhere(ClausulaWhere: String);
begin
   if qryPedidos.Active then
      qryPedidos.Close;
   qryPedidos.MacroByName('clausula_where').Value := ClausulaWhere;
   qryPedidos.Open;
end;

procedure TModelEntidadePedido.qryPedidos_ProdutosCalcFields(DataSet: TDataSet);
begin
   DataSet.FieldByName('valor_total').AsFloat := DataSet.FieldByName('valor_unitario').AsFloat * DataSet.FieldByName('quantidade').AsFloat;
end;

procedure TModelEntidadePedido.qryPedidos_ProdutosNewRecord(DataSet: TDataSet);
begin
   DataSet.FieldByName('numero_pedido').AsInteger := TFDQuery(DataSet).MasterSource.DataSet.FieldByName('numero').AsInteger;
   DataSet.FieldByName('quantidade').AsFloat := 1;
   DataSet.FieldByName('valor_unitario').AsFloat := 0;
end;

end.
